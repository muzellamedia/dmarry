<!DOCTYPE html>
  <html lang="ml">
  <head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Matrimony ‚Äî Login / Search / My Profile</title>
  <style>
    /* 1. ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥™‡µá‡¥ú‡µÅ‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥Ç ‡¥µ‡µá‡¥£‡µç‡¥ü‡¥ø */
    :root{--primary:#007bff;--danger:#d9534f;--muted:#666}
    /* body ‡¥∏‡µç‡¥±‡µç‡¥±‡µà‡¥≤‡¥ø‡µΩ ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥Ç ‡¥µ‡¥∞‡µÅ‡¥§‡µç‡¥§‡¥ø: padding: 18px ‡¥í‡¥¥‡¥ø‡¥µ‡¥æ‡¥ï‡µç‡¥ï‡¥ø */
    body{font-family:Arial,Helvetica,sans-serif;background:#f3f3f3;margin:0;padding:0; overflow-x: hidden;} /* ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£ ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µÄ‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥£‡¥æ‡µª */
    html{margin: 0; padding: 0;} /* ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£ ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µÄ‡¥®‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥£‡¥æ‡µª */

    /* 2. .container ‡¥ï‡µç‡¥≤‡¥æ‡¥∏‡µç ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥™‡µá‡¥ú‡¥ø‡¥®‡µç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥ø‡¥≤‡µç‡¥≤‡¥æ‡¥§‡µç‡¥§‡¥§‡¥ø‡¥®‡¥æ‡µΩ ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥ø */
    .container{max-width:1000px;margin:auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.06)}
    
    /* ‡¥Æ‡¥±‡µç‡¥±‡µç ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÅ‡¥≥‡µç‡¥≥ ‡¥∏‡µç‡¥±‡µç‡¥±‡µà‡¥≤‡µÅ‡¥ï‡µæ */
    h2{text-align:center;margin:6px 0 16px}
    input,button,select,textarea{padding:8px;margin:6px 0;border-radius:6px;border:1px solid #ddd;font-size:15px;box-sizing:border-box}
    button{background:var(--primary);color:#fff;border:none;cursor:pointer;padding:10px 14px;border-radius:6px}
    button:hover{opacity:.95}
    .small-btn{padding:8px 10px;font-size:14px}
    .flex{display:flex;gap:12px;align-items:center}
    .results{display:flex;flex-wrap:wrap;gap:15px;margin-top:20px;justify-content:center}
    .card{background:#fff;border:1px solid #e6e6e6;border-radius:8px;width:320px;padding:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);display:flex;flex-direction:column}
    .card img{width:100%;height:220px;object-fit:cover;border-radius:6px;cursor:pointer}
    .info{font-size:14px;text-align:left;margin-top:8px;overflow-x:auto}
    .info b{display:inline-block;width:110px}
    .no-photo{width:100%;height:220px;display:flex;align-items:center;justify-content:center;background:#eee;color:#555;font-size:20px;border-radius:6px}
    #error{color:red;margin-top:10px;text-align:center}
    .pagination{text-align:center;margin-top:15px}
    .footer-text{font-size:13px;color:#444;margin-top:14px;line-height:1.4;text-align:center}
    .register-note{font-size:14px;color:#333;margin-top:10px}
    .my-profile{max-width:540px;margin:20px auto 0;padding:18px;border-radius:12px;background:#fff;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
    .my-profile img{width:160px;height:160px;object-fit:cover;border-radius:12px;border:3px solid #eee;display:block;margin:0 auto}
    .profile-details{margin-top:12px;text-align:center;line-height:1.6}
    .actions{display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-top:14px}
    .action-btn{padding:8px 14px;border-radius:8px;border:none;cursor:pointer;background:var(--primary);color:#fff}
    .action-btn.danger{background:var(--danger)}
    .notice{color:var(--muted);font-size:13px;margin-top:8px;text-align:center}
    @media (max-width:640px){
      .card{width:92%}
      /* .container{padding:12px}  - ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥™‡µá‡¥ú‡¥ø‡¥®‡µç ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Æ‡¥ø‡¥≤‡µç‡¥≤ */
      .my-profile img{width:130px;height:130px}
    }
    /* ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÅ‡¥≥‡µç‡¥≥ <style> ‡¥∏‡µÜ‡¥ï‡µç‡¥∑‡¥®‡¥ø‡µΩ ‡¥á‡¥§‡µç ‡¥ï‡µÇ‡¥ü‡¥ø ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï */
#pageEdit form{max-width:400px;margin:auto}
#pageEdit input, #pageEdit select, #pageEdit textarea{width: 100%;} /* ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥á‡µª‡¥™‡µÅ‡¥ü‡µç‡¥ü‡µÅ‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µÅ‡¥Ç 100% ‡¥µ‡µÄ‡¥§‡¥ø ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ */
@media (max-width:640px){
  /* ... (‡¥Æ‡¥±‡µç‡¥±‡µÜ‡¥®‡µç‡¥§‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡¥≤‡µÅ‡¥Ç ‡¥∏‡µç‡¥±‡µç‡¥±‡µà‡¥≤‡µÅ‡¥ï‡µæ ‡¥â‡¥£‡µç‡¥ü‡µÜ‡¥ô‡µç‡¥ï‡¥ø‡µΩ ‡¥Ö‡¥§‡¥ø‡¥®‡µã‡¥ü‡µç ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï) */
}

/* ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡¥≤‡µÅ‡¥≥‡µç‡¥≥ <style> ‡¥∏‡µÜ‡¥ï‡µç‡¥∑‡¥®‡¥ø‡µΩ ‡¥á‡¥§‡µç ‡¥ï‡µÇ‡¥ü‡¥ø ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥ï */

/* ‡¥¨‡µç‡¥∞‡µó‡¥∏‡¥±‡¥ø‡µª‡µç‡¥±‡µÜ ‡¥°‡¥ø‡¥´‡µã‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥µ‡¥æ‡¥≤‡¥ø‡¥°‡µá‡¥∑‡µª ‡¥â‡¥™‡¥Ø‡µã‡¥ó‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥á‡µª‡¥µ‡¥æ‡¥≤‡¥ø‡¥°‡µç ‡¥´‡µÄ‡µΩ‡¥°‡µÅ‡¥ï‡µæ‡¥ï‡µç‡¥ï‡µç ‡¥ö‡µÅ‡¥µ‡¥™‡µç‡¥™‡µç ‡¥¨‡µã‡µº‡¥°‡µº ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ */
#regForm input:required:invalid:not(:focus),
#regForm select:required:invalid:not(:focus),
#regForm textarea:required:invalid:not(:focus) {
    border: 2px solid var(--danger) !important; /* --danger ‡¥é‡¥®‡µç‡¥®‡¥§‡µç ‡¥ö‡µÅ‡¥µ‡¥™‡µç‡¥™‡µç ‡¥®‡¥ø‡¥±‡¥Æ‡¥æ‡¥£‡µç */
}

/* ‡¥´‡µã‡¥ï‡µç‡¥ï‡¥∏‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥°‡¥ø‡¥´‡µã‡µæ‡¥ü‡µç‡¥ü‡µç ‡¥¨‡µã‡µº‡¥°‡µº ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡µÅ‡¥®‡µç‡¥®‡µÅ */
#regForm input:focus:invalid,
#regForm select:focus:invalid,
#regForm textarea:focus:invalid {
    border-color: var(--primary) !important; /* ‡¥´‡µã‡¥ï‡µç‡¥ï‡¥∏‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥Æ‡µç‡¥™‡µã‡µæ ‡¥®‡µÄ‡¥≤ ‡¥¨‡µã‡µº‡¥°‡µº */
}

/* ‡¥ü‡µÜ‡¥ï‡µç‡¥∏‡µç‡¥±‡µç‡¥±‡µç‡¥è‡¥∞‡¥ø‡¥Ø‡¥Ø‡¥ø‡µΩ ‡¥¨‡µã‡µº‡¥°‡µº ‡¥µ‡µç‡¥Ø‡¥ï‡µç‡¥§‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥£‡¥æ‡µª */
#regForm textarea {
    resize: vertical; /* ‡¥µ‡µÜ‡µº‡¥ü‡µç‡¥ü‡¥ø‡¥ï‡µç‡¥ï‡µΩ ‡¥µ‡¥≤‡µÅ‡¥™‡µç‡¥™‡¥Ç ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥æ‡µª ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç ‡¥Ö‡¥®‡µÅ‡¥µ‡¥¶‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ */
}
    /* Modal */
    .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.9);align-items:center;justify-content:center;padding:20px}
    .modal img{max-width:100%;max-height:90vh;border-radius:8px}
    .modal .close{position:absolute;top:18px;right:22px;color:#fff;font-size:28px;cursor:pointer}
  </style>
  </head>
  <body>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <style>
        /* 3. body ‡¥ï‡µç‡¥ï‡µç ‡¥Æ‡µÅ‡¥Æ‡µç‡¥™‡µç ‡¥§‡¥®‡µç‡¥®‡µÜ html, body ‡¥∏‡µç‡¥±‡µç‡¥±‡µà‡¥≤‡µÅ‡¥ï‡µæ ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡¥ø‡¥ü‡µç‡¥ü‡µÅ‡¥£‡µç‡¥ü‡µç */
    </style>
</head>
<body>

<div id="pageLogin"
  style="
    /* ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥¨‡µã‡¥ï‡µç‡¥∏‡µç ‡¥∏‡µÜ‡¥®‡µç‡¥±‡µº ‡¥Ü‡¥ï‡µç‡¥ï‡¥æ‡¥®‡µÅ‡¥≥‡µç‡¥≥ ‡¥∏‡µç‡¥±‡µç‡¥±‡µà‡¥≤‡µÅ‡¥ï‡µæ */
    display:flex;
    justify-content:center;
    align-items:center;
    /* ‡¥Æ‡µÅ‡¥¥‡µÅ‡¥µ‡µª ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µÄ‡¥®‡¥ø‡¥≤‡µÅ‡¥Ç ‡¥ï‡¥æ‡¥£‡¥æ‡µª */
    height:100vh;
    width:100%; /* width:100vw; ‡¥é‡¥®‡µç‡¥®‡¥§‡¥ø‡¥®‡µÅ ‡¥™‡¥ï‡¥∞‡¥Ç 100% ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ, body ‡¥ï‡µç‡¥ï‡µç margin, padding ‡¥á‡¥≤‡µç‡¥≤‡¥æ‡¥§‡µç‡¥§‡¥§‡¥ø‡¥®‡¥æ‡µΩ ‡¥á‡¥§‡µç ‡¥´‡µÅ‡µæ ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µÄ‡µª ‡¥Ü‡¥ï‡µÅ‡¥Ç */
    margin:0;
    padding:0;
    /* ‡¥¨‡¥æ‡¥ï‡µç‡¥ï‡µç‡¥ó‡µç‡¥∞‡µó‡¥£‡µç‡¥ü‡µç ‡¥á‡¥Æ‡µá‡¥ú‡µç */
    background:url('https://lh3.googleusercontent.com/d/1yrIBB7Dz1eGdnFdAzk8xr_dOo3lKpuJN') no-repeat center center / cover;
    box-sizing:border-box;
    background-color:#333; /* ‡¥á‡¥Æ‡µá‡¥ú‡µç ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡¥§‡µç‡¥§ ‡¥∏‡¥æ‡¥π‡¥ö‡¥∞‡µç‡¥Ø‡¥§‡µç‡¥§‡¥ø‡µΩ */
  ">

  <div style="
    /* ‡¥¨‡¥æ‡¥ï‡µç‡¥ï‡µç‡¥ó‡µç‡¥∞‡µó‡¥£‡µç‡¥ü‡µç ‡¥™‡µÇ‡µº‡¥£‡µç‡¥£‡¥Æ‡¥æ‡¥Ø‡¥ø ‡¥ü‡µç‡¥∞‡¥æ‡µª‡¥∏‡µç‡¥™‡¥∞‡µª‡µç‡¥±‡µç */
    background:none; 
    padding:30px 25px;
    border-radius:15px;
    /* ‡¥Æ‡µÅ‡¥¥‡µÅ‡¥µ‡µª ‡¥µ‡µÄ‡¥§‡¥ø‡¥Ø‡¥ø‡µΩ ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª 100% ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ, max-width ‡¥®‡¥ø‡¥Ø‡¥®‡µç‡¥§‡µç‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ */
    width:100%; 
    /* ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥Æ‡µä‡¥¨‡µà‡¥≤‡¥ø‡¥≤‡µÅ‡¥Ç ‡¥µ‡µÉ‡¥§‡µç‡¥§‡¥ø‡¥Ø‡¥æ‡¥Ø‡¥ø ‡¥ï‡¥æ‡¥£‡¥æ‡µª ‡¥™‡¥∞‡¥Æ‡¥æ‡¥µ‡¥ß‡¥ø ‡¥µ‡µÄ‡¥§‡¥ø (‡¥á‡¥§‡µç ‡¥®‡¥ø‡¥ô‡µç‡¥ô‡¥≥‡µÅ‡¥ü‡µÜ ‡¥Ü‡¥µ‡¥∂‡µç‡¥Ø‡¥Ç ‡¥Ö‡¥®‡µÅ‡¥∏‡¥∞‡¥ø‡¥ö‡µç‡¥ö‡µç ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥æ‡¥Ç) */
    max-width:380px; 
    text-align:center;
    /* ‡¥ü‡µÜ‡¥ï‡µç‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥ï‡¥≥‡µº ‡¥µ‡µà‡¥±‡µç‡¥±‡µç */
    color:#fff; 
    /* ‡¥ö‡µÜ‡¥±‡¥ø‡¥Ø ‡¥∑‡¥æ‡¥°‡µã ‡¥®‡µΩ‡¥ï‡¥ø, ‡¥¨‡µã‡¥ï‡µç‡¥∏‡¥ø‡¥®‡µç ‡¥í‡¥∞‡µÅ ‡¥°‡µÜ‡¥™‡µç‡¥§‡µç ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ */
    box-shadow:0 8px 20px rgba(0,0,0,0.25); 
    backdrop-filter: blur(2px); 
    -webkit-backdrop-filter: blur(2px);
    /* ‡¥∏‡µà‡¥°‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ ‡¥í‡¥∞‡µÅ ‡¥®‡¥ø‡¥∂‡µç‡¥ö‡¥ø‡¥§ ‡¥™‡¥æ‡¥°‡¥ø‡¥Ç‡¥ó‡µç ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ, ‡¥â‡¥≥‡µç‡¥≥‡¥ü‡¥ï‡µç‡¥ï‡¥Ç ‡¥Ö‡¥∞‡¥ø‡¥ï‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥Ö‡¥ï‡¥±‡µç‡¥±‡¥æ‡µª */
    padding-left: 25px;
    padding-right: 25px;
    box-sizing: border-box; /* padding ‡¥â‡¥Ç border ‡¥â‡¥Ç width-‡µΩ ‡¥â‡µæ‡¥™‡µç‡¥™‡µÜ‡¥ü‡µÅ‡¥§‡µç‡¥§‡¥æ‡µª */
  ">

    <img src="https://lh3.googleusercontent.com/d/1pKfOnhW0cfZzRU8qkrcydfJeDWLMwB4e"
      alt="DM Logo"
      style="width:100px;height:100px;margin:0 auto 15px auto;display:block;border-radius:50%;border:3px solid #fff;">

    <h3 style="color:#ff0;font-size:16px;line-height:1.4;margin-bottom:20px;font-weight:600;">
      ‡¥ï‡µá‡¥∞‡¥≥‡¥§‡µç‡¥§‡¥ø‡¥≤‡µÜ ‡¥≠‡¥ø‡¥®‡µç‡¥®‡¥∂‡µá‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥∏‡µó‡¥ú‡¥®‡µç‡¥Ø ‡¥Æ‡¥æ‡¥ü‡µç‡¥∞‡¥ø‡¥Æ‡µã‡¥£‡¥ø ‡¥µ‡µÜ‡¥¨‡µç‡¥∏‡µà‡¥±‡µç‡¥±‡µç
    </h3>
    
    <label style="display:block;text-align:left;font-size:14px;margin:6px 0 4px 4px;font-weight:500;">Your Phone Number</label>
    <input type="tel" id="phone" placeholder="Enter your registered phone number"
      style="width:100%;padding:12px;border:none;border-radius:6px;font-size:15px;margin-bottom:10px;box-sizing:border-box;background:rgba(255,255,255,0.9);color:#333;">

    <label style="display:block;text-align:left;font-size:14px;margin:6px 0 4px 4px;font-weight:500;">Date of Birth</label>
    <div style="display:flex;gap:6px;margin-bottom:15px;">
      <select id="day" style="flex:1;padding:12px;border:none;border-radius:6px;font-size:16px;box-sizing:border-box;background:rgba(255,255,255,0.9);color:#333;"><option value="">Day</option></select>
      <select id="month" style="flex:1;padding:12px;border:none;border-radius:6px;font-size:16px;box-sizing:border-box;background:rgba(255,255,255,0.9);color:#333;"><option value="">Month</option></select>
      <select id="year" style="flex:1;padding:12px;border:none;border-radius:6px;font-size:16px;box-sizing:border-box;background:rgba(255,255,255,0.9);color:#333;"><option value="">Year</option></select>
    </div>

    <button onclick="login()" 
      style="width:100%;padding:13px;border:none;border-radius:25px;background:#00b050;color:#fff;
      font-size:17px;font-weight:bold;cursor:pointer;margin-bottom:12px;transition:background 0.3s;">
      Login
    </button>

    <button onclick="showPage('pageRegister')" 
      style="width:100%;padding:13px;border:none;border-radius:25px;background:#001a66;color:#fff;
      font-size:17px;font-weight:bold;cursor:pointer;transition:background 0.3s;">
      Register Now
    </button>

    <div id="error" style="color:#ff8080;margin-top:10px;font-size:14px;"></div>
    <div style="font-size:12px;color:#0ff;margin-top:15px;">Designed by SUNEER PARAMBIL</div>

  </div>
</div>

<!-- üîµ GLOBAL LOADING POPUP -->
<div id="loadingPopup" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.8);
  z-index:9999;
  justify-content:center;
  align-items:center;
  color:#fff;
  font-size:20px;
  font-weight:bold;
  text-align:center;
">
  <div style="
    background:#111;
    padding:25px 30px;
    border-radius:10px;
    box-shadow:0 0 10px rgba(255,255,255,0.3);
  ">
    <div id="loadingText">Processing...</div>
    <div style="margin-top:15px; font-size:14px; color:#ccc;">Please wait...</div>
  </div>
</div>

<!-- ‚úÖ SUCCESS POPUP -->
<div id="successPopup" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.85);
  z-index:99999;
  justify-content:center;
  align-items:center;
">
  <div style="
    background:#111;
    padding:25px 30px;
    border-radius:12px;
    text-align:center;
    color:#fff;
    box-shadow:0 0 15px rgba(255,255,255,0.3);
    max-width:300px;
  ">
    <h3 style="color:#00ff9d;margin-bottom:10px;">‚úÖ Successfully Registered</h3>
    <p style="color:#ddd;font-size:14px;margin-bottom:20px;">Please login to continue</p>
    
    <button onclick="closeSuccessPopup()" 
      style="background:#00b050;color:#fff;padding:10px 20px;border:none;
      border-radius:8px;font-size:16px;cursor:pointer;">
      Login
    </button>
  </div>
</div>

<script>
function showLoadingPopup(message){
  const popup = document.getElementById('loadingPopup');
  document.getElementById('loadingText').innerText = message || "Please wait...";
  popup.style.display = 'flex';
  document.body.style.pointerEvents = 'none'; // disable all clicks
}

function hideLoadingPopup(){
  const popup = document.getElementById('loadingPopup');
  popup.style.display = 'none';
  document.body.style.pointerEvents = 'auto'; // enable again
}
function showSuccessPopup(){
  document.getElementById('successPopup').style.display = 'flex';
}

function closeSuccessPopup(){
  document.getElementById('successPopup').style.display = 'none';
  showPage('pageLogin');
  window.scrollTo(0,0);
}
function closeSuccessPopup() {
    document.getElementById('successPopup').style.display = 'none';
    showPage('pageLogin');
    window.scrollTo(0, 0);
}



</script>

</body>
</html>






    <div id="pageRegister" style="display:none;">
  <h2 style="text-align:center;">üìù Matrimony Registration Form</h2>

  <form id="regForm" style="max-width:600px;margin:auto;padding:15px;">
    <style>
      #regForm {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }
      #regForm label {
        font-weight: bold;
        margin-bottom: 3px;
      }
      #regForm input,
      #regForm select,
      #regForm textarea {
        width: 100%;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 16px;
        box-sizing: border-box;
      }
      #regForm textarea {
        min-height: 80px;
      }
      .dob-selects {
        display: flex;
        gap: 8px;
      }
      .dob-selects select {
        flex: 1;
      }
      .btn-group button {
        background: #007bff;
        color: #fff;
        border: none;
        padding: 12px 20px;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
      }
      .btn-group button:hover {
        background: #0056b3;
      }
      .btn-group {
        display: flex;
        justify-content: center;
        gap: 10px;
      }

      /* üåê Responsive */
      @media (max-width: 600px) {
        body {
          padding: 10px;
        }
        #regForm {
          gap: 12px;
        }
        .dob-selects {
          flex-direction: column;
        }
        .btn-group {
          flex-direction: column;
        }
        .btn-group button {
          width: 100%;
        }
      }
    </style>

    <label>Name</label>
    <input name="Name" required>

    <label>Your Phone Number</label>
    <input 
   name="Your Phone Number"
   id="regPhone"
   type="tel"
   required
   minlength="10"
   maxlength="10"
   pattern="[0-9]{10}"
   inputmode="numeric"
   autocomplete="tel"
>

    <label>Date of Birth</label>
    <div class="dob-selects">
      <select name="Day" required><option value="">Day</option></select>
      <select name="Month" required><option value="">Month</option></select>
      <select name="Year" required><option value="">Year</option></select>
    </div>

    <label>Age</label>
    <input name="Age" type="number" min="18" max="100" required>

    <label>Gender</label>
    <select name="Gender" required>
      <option value="">Select</option>
      <option>Male</option>
      <option>Female</option>
    </select>

    <label>Height</label>
    <input name="Height">

    <label>Religion</label>
    <select name="Religion" required>
      <option value="">Select</option>
      <option>Muslim</option>
      <option>Hindu</option>
      <option>Christian</option>
    </select>

    <label>Caste</label>
    <input name="Caste">

    <label>Disability Details</label>
    <select name="Disability Details" required>
      <option value="">Select</option>
      <option>Deaf</option>
      <option>Blind</option>
      <option>Physical Disabilities</option>
      <option>Learning Disabilities</option>
      <option>MR</option>
      <option>Other Disabilities</option>
    </select>

    <label>Education</label>
    <input name="Education" required>

    <label>Job</label>
    <input name="Job">

    <label>Marital Status</label>
    <select name="Marital Status" required>
      <option value="">Select</option>
      <option>Unmarried</option>
      <option>Divorced</option>
      <option>Nikah Divorced</option>
    </select>

    <label>Full Address</label>
    <textarea name="Full Address" required></textarea>

    <label>District</label>
    <select name="District" required>
      <option value="">Select District</option>
      <option>Thiruvananthapuram</option>
      <option>Kollam</option>
      <option>Pathanamthitta</option>
      <option>Alappuzha</option>
      <option>Kottayam</option>
      <option>Idukki</option>
      <option>Ernakulam</option>
      <option>Thrissur</option>
      <option>Palakkad</option>
      <option>Malappuram</option>
      <option>Kozhikode</option>
      <option>Wayanad</option>
      <option>Kannur</option>
      <option>Kasaragod</option>
    </select>

    <label>Contact Number 1</label>
    <input name="Contact Number 1" required>

    <label>Contact Number 2</label>
    <input name="Contact Number 2">

    <label>About Me</label>
    <textarea name="About Me"></textarea>

    <label>Upload Your Photo</label>
    <input type="file" name="photoFile" accept="image/*">
    
    

    <div id="status" style="text-align:center;margin-top:8px;"></div> <div class="btn-group" style="margin-top:20px">
      <button id="submitBtn" type="button" onclick="registerUser()">Submit</button>
      <button type="button" onclick="showPage('pageLogin')" style="background:#ccc;color:#000;">Back to Login</button>
    </div>
  </form>
</div>


<div id="pageInterests" style="display:none">
  <h2 id="interestListTitle">üì• Received Interests</h2>

  <div style="margin-bottom:10px;text-align:center">
    <button onclick="showPage('pageSearch')">Back to Search</button> 
    <button onclick="logout()" style="background:#dc3545;margin-left:8px">Logout</button>
  </div>
  
  <div class="results" id="interestResults"></div> 
  
  <div class="pagination" id="interestPagination"></div> 
  
  <div class="footer-text" style="margin-top:14px">‡¥≠‡¥ø‡¥®‡µç‡¥®‡¥∂‡µá‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µº‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥ø‡¥µ‡¥æ‡¥π‡¥Æ‡µÜ‡¥®‡µç‡¥® ‡¥∏‡µç‡¥µ‡¥™‡µç‡¥®‡¥Ç ‡¥™‡µÇ‡¥µ‡¥£‡¥ø‡¥Ø‡¥æ‡µª ‡¥∏‡µó‡¥ú‡¥®‡µç‡¥Ø ‡¥µ‡µÜ‡¥¨‡µç‡¥∏‡µà‡¥±‡µç‡¥±‡µç ‚Äî Website design by SUNEER PARAMBIL</div>
</div>


  <div id="pageSearch" style="display:none;">
  <h2>üîç Matrimony Profile Search</h2>

  <div class="search-form-container" style="max-width:400px;margin:auto;padding: 0 10px;"> 
    
    <div>
      <label>Age</label><br>
      <div style="display:flex;gap:8px;">
        <select id="ageMin" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;">
          <option value="">Min</option>
        </select>
        <select id="ageMax" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;">
          <option value="">Max</option>
        </select>
      </div>
    </div>
    <div>
      <label>District</label><br>
      <select id="district" style="width:100%;">
        <option value="">All</option>
        <option>Thiruvananthapuram</option>
        <option>Kollam</option>
        <option>Pathanamthitta</option>
        <option>Alappuzha</option>
        <option>Kottayam</option>
        <option>Idukki</option>
        <option>Ernakulam</option>
        <option>Thrissur</option>
        <option>Palakkad</option>
        <option>Malappuram</option>
        <option>Kozhikode</option>
        <option>Wayanad</option>
        <option>Kannur</option>
        <option>Kasaragod</option>
      </select>
    </div>

    <div>
      <label>Disability</label><br>
      <select id="disability" style="width:100%;">
        <option value="">All</option>
        <option>Deaf</option>
        <option>Blind</option>
        <option>Physical Disabilities</option>
        <option>Learning Disabilities</option>
        <option>MR</option> <!-- üëà ‡¥ö‡µá‡µº‡¥§‡µç‡¥§‡µÅ -->
        <option>Other Disabilities</option>
      </select>
    </div>
  </div>

  <div style="text-align:center;margin-top:18px;">
    <button onclick="applySearch()">Search</button>
    <button onclick="logout()" style="background:#dc3545;margin-left:10px;">Logout</button>
  </div>

  <div class="notice">Tip: Leave fields empty to include all.</div>
</div>
<script>

  // ‚úÖ Fill age dropdowns 18‚Äì65 dynamically
  const minSel = document.getElementById('ageMin');
  const maxSel = document.getElementById('ageMax');
  for (let i = 18; i <= 65; i++) {
    let opt1 = document.createElement('option');
    opt1.value = i; opt1.text = i;
    minSel.appendChild(opt1);
    let opt2 = document.createElement('option');
    opt2.value = i; opt2.text = i;
    maxSel.appendChild(opt2);
  }
  // Default values
  minSel.value = "18";
  maxSel.value = "65";
</script>


      <!-- MY PROFILE -->
<div id="myProfileSection" class="my-profile" style="display:none;max-width:600px;margin:auto;text-align:center;">

  <h2 style="color:#003366;margin-bottom:15px;">My Profile Details</h2>

  <img id="myProfilePhoto" 
       src="https://via.placeholder.com/150?text=No+Photo" 
       alt="Profile Photo" 
       style="width:140px;height:140px;border-radius:50%;border:4px solid #00b050;object-fit:cover;margin-bottom:15px;">

  <div id="myProfileDetails" class="profile-details" 
       style="background:#f9f9f9;border-radius:10px;padding:15px;margin-bottom:20px;text-align:left;box-shadow:0 0 6px rgba(0,0,0,0.1);">
  </div>

  <!-- Action Buttons Grid -->
  <div class="actions-grid" 
       style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px;">
    
    <button class="action-box" onclick="editProfile()" 
            style="background:#007bff;color:#fff;border:none;border-radius:12px;padding:15px 10px;font-weight:bold;
                   cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,0.2);">
      ‚úèÔ∏è<br>Edit Profile
    </button>
    
    <button class="action-box" onclick="changePhoto()" 
            style="background:#17a2b8;color:#fff;border:none;border-radius:12px;padding:15px 10px;font-weight:bold;
                   cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,0.2);">
      üì∏<br>Change Photo
    </button>
    
    <button class="action-box" onclick="deletePhoto()" 
            style="background:#ffc107;color:#000;border:none;border-radius:12px;padding:15px 10px;font-weight:bold;
                   cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,0.2);">
      üóëÔ∏è<br>Delete Photo
    </button>
    
    <button class="action-box" onclick="deleteProfile()" 
            style="background:#dc3545;color:#fff;border:none;border-radius:12px;padding:15px 10px;font-weight:bold;
                   cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,0.2);">
      ‚ùå<br>Delete Profile
      <div class="actions-grid" 
       style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:12px;margin-bottom:20px;">
    
    <button class="action-box" onclick="showInterestList('received')" 
            style="background:#00695c;color:#fff;border-radius:12px;padding:15px 10px;font-weight:bold;cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,0.2);">
      üì•<br>Received Interests
    </button>

    <button class="action-box" onclick="showInterestList('accepted')" 
            style="background:#007bff;color:#fff;border-radius:12px;padding:15px 10px;font-weight:bold;cursor:pointer;box-shadow:0 3px 6px rgba(0,0,0,0.2);">
      ü§ù<br>Accepted Interests
    </button>
  </div>

  <div id="interestListContainer" style="margin-top:20px; display:none;">
    <h3 id="interestListHeading" style="text-align:center; color:#0056b3; margin-bottom:15px;"></h3>
    <div id="interestListContent" style="padding:15px; background:#f5f5f5; border-radius:8px;">
      </div>
    <button onclick="hideInterestList()" style="margin-top:10px; background:#6c757d; display:block; width:100%;" class="small-btn">Close List</button>
  </div>
 

  <p id="myProfileStatus" style="text-align:center;color:#666;font-size:14px;margin-top:5px;"></p>

  <div class="footer-text" style="margin-top:18px;font-size:13px;color:#555;line-height:1.4;">
    ‡¥≠‡¥ø‡¥®‡µç‡¥®‡¥∂‡µá‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥∞‡µç‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥ø‡¥µ‡¥æ‡¥π‡¥Æ‡µÜ‡¥®‡µç‡¥® ‡¥∏‡µç‡¥µ‡¥™‡µç‡¥®‡¥Ç ‡¥™‡µÇ‡¥µ‡¥£‡¥ø‡¥Ø‡¥æ‡µª ‡¥∏‡µó‡¥ú‡¥®‡µç‡¥Ø ‡¥µ‡µÜ‡¥¨‡µç‡¥∏‡µà‡¥±‡µç‡¥±‡µç<br>
    <strong>Website design by SUNEER PARAMBIL</strong>
  </div>
</div>

<div id="pageEdit" style="display:none;">
    <h2 style="text-align:center;">‚úèÔ∏è Edit Profile</h2>

    <form id="editForm" style="max-width:600px;margin:auto;padding:15px;">
        <style>
          #editForm {
            display: flex;
            flex-direction: column;
            gap: 12px;
          }
          #editForm label {
            font-weight: bold;
            margin-bottom: 3px;
            display: block; /* ‡¥≤‡µá‡¥¨‡¥≤‡µÅ‡¥ï‡µæ ‡¥µ‡µá‡µº‡¥§‡¥ø‡¥∞‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡µª */
          }
          #editForm input,
          #editForm select,
          #editForm textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
          }
          #editForm textarea {
            min-height: 80px;
          }
        </style>

        <p style="color:#007bff; text-align:center; font-weight:bold;">Only listed fields are editable.</p>

        <label>Name</label>
        <input name="Name" id="editName" required>
        
        <label>Date of Birth (Not Editable)</label>
        <input name="Date of Birth" id="editDob" disabled style="background:#eee; color:#666;">

        <label>Height</label>
        <input name="Height" id="editHeight">
        
        <label>Disability Details</label>
        <select name="Disability Details" id="editDisability" required>
            <option value="">Select</option>
            <option>Deaf</option>
            <option>Blind</option>
            <option>Physical Disabilities</option>
            <option>Learning Disabilities</option>
            <option>MR</option>
            <option>Other Disabilities</option>
        </select>

        <label>Education</label>
        <input name="Education" id="editEducation" required>

        <label>Job</label>
        <input name="Job" id="editJob">

        <label>Marital Status</label>
        <select name="Marital Status" id="editMaritalStatus" required>
            <option value="">Select</option>
            <option>Unmarried</option>
            <option>Divorced</option>
            <option>Nikah Divorced</option>
        </select>
        
        <label>Full Address</label>
        <textarea name="Full Address" id="editAddress" required></textarea>

        <label>District</label>
        <select name="District" id="editDistrict" required>
            <option value="">Select District</option>
            <option>Thiruvananthapuram</option>
            <option>Kollam</option>
            <option>Pathanamthitta</option>
            <option>Alappuzha</option>
            <option>Kottayam</option>
            <option>Idukki</option>
            <option>Ernakulam</option>
            <option>Thrissur</option>
            <option>Palakkad</option>
            <option>Malappuram</option>
            <option>Kozhikode</option>
            <option>Wayanad</option>
            <option>Kannur</option>
            <option>Kasaragod</option>
        </select>

        <label>Contact Number 1</label>
        <input name="Contact Number 1" id="editContact1" required>

        <label>Contact Number 2</label>
        <input name="Contact Number 2" id="editContact2">
        
        <label>About Me</label>
        <textarea name="About Me" id="editAboutMe"></textarea>

        <div class="btn-group" style="margin-top:20px; display:flex; gap:10px; justify-content:center;">
            <button type="button" onclick="updateProfile()" style="background:#28a745;">üíæ Update Profile</button>
            <button type="button" onclick="showPage('pageSearch')" style="background:#6c757d;">Back to Profile</button>
        </div>

        <div id="editStatus" style="text-align:center;margin-top:8px;"></div>
    </form>
</div>

    <!-- RESULTS -->
    <div id="pageResults" style="display:none">
      <h2>Search Results</h2>
      <div style="margin-bottom:10px;text-align:center">
        <button onclick="backToSearch()">Back to Search</button>
        <button onclick="logout()" style="background:#dc3545;margin-left:8px">Logout</button>
      </div>
      <div class="results" id="results"></div>
      <div class="pagination" id="pagination"></div>
      <div class="footer-text" style="margin-top:14px">‡¥≠‡¥ø‡¥®‡µç‡¥®‡¥∂‡µá‡¥∑‡¥ø‡¥ï‡µç‡¥ï‡¥æ‡¥∞‡µç‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥ø‡¥µ‡¥æ‡¥π‡¥Æ‡µÜ‡¥®‡µç‡¥® ‡¥∏‡µç‡¥µ‡¥™‡µç‡¥®‡¥Ç ‡¥™‡µÇ‡¥µ‡¥£‡¥ø‡¥Ø‡¥æ‡µª ‡¥∏‡µó‡¥ú‡¥®‡µç‡¥Ø ‡¥µ‡µÜ‡¥¨‡µç‡¥∏‡µà‡¥±‡µç‡¥±‡µç ‚Äî Website design by SUNEER PARAMBIL</div>
    </div>

  </div>

<div id="imgModal" class="modal">
  <img class="modal-content" id="modalImg">
</div>

<script>
const modal = document.getElementById('imgModal');
const modalImg = document.getElementById('modalImg');

function openModal(src) {
  modal.style.display = 'flex';
  modalImg.src = src;
}

// ‡¥ü‡¥ö‡µç‡¥ö‡µç / ‡¥ï‡µç‡¥≤‡¥ø‡¥ï‡µç‡¥ï‡µç anywhere to close
modal.addEventListener('click', () => {
  modal.style.display = 'none';
});
</script>

<style>
.modal {
  display:none;
  position:fixed;
  z-index:1000;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,0.9);
  justify-content:center;
  align-items:center;
}
.modal-content {
  max-width:90%;
  max-height:90%;
  border-radius:10px;
}
</style>





  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
  let csvReady = false;

  /* ========== CONFIG ========== */
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwvPQMb3qtMEqbFN8hwXqZdfgBEQoGH_CBL3AGEQA9XP9ctFHYePsSMWgeXLIilXves/exec"; // <-- set your script URL
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQHJLHXWQaMioqSExrL-vdbu65_py6Ti9KzPtkxXaMaj9CygZ9OFH1a3ne7rCQ0_fF_KhNc-OiPDmvo/pub?output=csv"; // your published CSV

/* ========== STATE ========== */
let allProfiles = [];        // all rows from CSV
let filteredProfiles = [];   // search results
let currentPage = 1;
const profilesPerPage = 10;
let loggedProfile = null;    // object for logged-in user (row)
let loggedInGender = "";

let interestsList = [];        // Received/Accepted Interest List profiles
let currentInterestPage = 1;   // Interest List ‡¥®‡µç‚Äç‡¥±‡µÜ ‡¥™‡µá‡¥ú‡¥ø‡¥®‡µá‡¥∑‡µª
const interestProfilesPerPage = 10; // ‡¥í‡¥∞‡µÅ ‡¥™‡µá‡¥ú‡¥ø‡µΩ 10 ‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡¥≤‡µÅ‡¥ï‡µæ
let currentInterestListType = ""; 
let interestsSentByMe = new Map();



  /* ========== Helpers ========== */
function showPage(id){
  ["pageLogin","pageRegister","pageSearch","pageResults", "pageEdit", "pageInterests"].forEach(pid=>{ 
    const el = document.getElementById(pid);
    if(el) el.style.display = (pid===id) ? "block" : "none";
  });
  
  const myProfileEl = document.getElementById('myProfileSection');
  if(myProfileEl) {
      myProfileEl.style.display = (id === 'pageSearch' && loggedProfile) ? 'block' : 'none'; 
  }

  // Only 1 scroll enough
  window.scrollTo(0, 0);
}

  /* Fill day/month/year selects (used in login + register) */
  function fillDobSelects(){
    const dayEls = document.querySelectorAll("#day, select[name='Day']");
    const monthEls = document.querySelectorAll("#month, select[name='Month']");
    const yearEls = document.querySelectorAll("#year, select[name='Year']");
    if(dayEls[0].children.length===1){
      for(let i=1;i<=31;i++) dayEls.forEach(e=>e.insertAdjacentHTML('beforeend',`<option value="${i}">${i}</option>`));
    }
    if(monthEls[0].children.length===1){
      for(let i=1;i<=12;i++) monthEls.forEach(e=>e.insertAdjacentHTML('beforeend',`<option value="${i}">${i}</option>`));
    }
    if(yearEls[0].children.length===1){
      for(let i=new Date().getFullYear(); i>=1960; i--) yearEls.forEach(e=>e.insertAdjacentHTML('beforeend',`<option value="${i}">${i}</option>`));
    }
  }
  // fillDobSelects(); // ‚úÖ ‡¥à ‡¥ï‡µã‡µæ ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µç ‡¥Æ‡¥æ‡¥±‡µç‡¥±‡¥ø ‡¥Ö‡¥µ‡¥∏‡¥æ‡¥®‡¥Ç ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ.

  function convertDriveLink(url) {
  if (!url) return "";
  
  let finalUrl = "";

  if (url.includes("https://drive.google.com/uc?export=view&id=")) {
    const fileId = url.split("id=")[1];
    finalUrl = "https://lh3.googleusercontent.com/d/" + fileId;
  } 
  else if (url.includes("open?id=")) {
    const fileId = url.split("open?id=")[1].split("&")[0];
    finalUrl = "https://lh3.googleusercontent.com/d/" + fileId;
  } 
  else if (url.includes("/file/d/")) {
    const fileId = url.split("/file/d/")[1].split("/")[0];
    finalUrl = "https://lh3.googleusercontent.com/d/" + fileId;
  }
  else {
    finalUrl = url;
  }

  // ‚≠ê Cache Busting: Always load fresh
  return finalUrl + "?v=" + Date.now();
}

 

 /* ========== LOGIN - (FINAL UPDATED WITH SENT INTEREST LOADER) ========== */
async function login() {
    const phone = document.getElementById('phone').value.trim();
    const day = document.getElementById('day').value;
    const month = document.getElementById('month').value;
    const year = document.getElementById('year').value;
    const err = document.getElementById('error');
    err.textContent = "";

    if (!phone) { err.textContent = "Please enter phone number."; return; }
    if (!day || !month || !year) { err.textContent = "Please select full date of birth."; return; }

    const enteredDob = `${parseInt(day)}/${parseInt(month)}/${year}`
        .replace(/[^\d]/g, "/")
        .trim();

    try {
        // ‚≠ê STEP 1 ‚Üí Load CSV fully before login
        await loadProfilesFully();

        // ‚≠ê STEP 2 ‚Üí Now login check will work FIRST CLICK itself
        const match = allProfiles.find(p => {
            const phoneDb = (p["Your Phone Number"] || "").trim();
            const dobDb = (p["Date of Birth"] || "").trim()
                .replace(/[^\d]/g, "/")
                .trim();
            return phoneDb === phone && dobDb === enteredDob;
        });

        if (match) {
            loggedProfile = match;

            localStorage.setItem('loggedProfile', JSON.stringify({
                "Your Phone Number": match["Your Phone Number"],
                "Date of Birth": match["Date of Birth"]
            }));

            showPage('pageSearch');
            showMyProfile(match);
            await loadSentInterests();  // ‚≠ê VERY IMPORTANT


        } else {
            err.textContent = "Invalid phone number or date of birth!";
        }

    } catch (e) {
        err.textContent = "Network error!";
        console.error(e);
    }
}

  /* ========== LOGOUT (ADDED) ========== */
  function logout(){
      loggedProfile = null;
      localStorage.removeItem('loggedProfile');
      showPage('pageLogin');
      document.getElementById('myProfileSection').style.display = 'none';
      document.getElementById('error').textContent = "";
      document.getElementById('phone').value = "";
      document.getElementById('day').value = "";
      document.getElementById('month').value = "";
      document.getElementById('year').value = "";
  }

/* ========== REGISTER (FINAL UPDATED) ========== */
async function registerUser(){
  const statusDiv = document.getElementById('status');
  const form = document.getElementById('regForm');
  const submitBtn = document.getElementById('submitBtn');

  statusDiv.textContent = "";
  
  if(!form.checkValidity()){
    statusDiv.style.color = 'red';
    statusDiv.textContent = 'Please fill required fields.';
    window.scrollTo({ top: 0, behavior: 'smooth' });
    return;
  }

  // ‚úÖ ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ popup ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥ï ‚Äî ‡¥´‡µã‡¥Æ‡¥ø‡µΩ ‡¥é‡¥≤‡µç‡¥≤‡¥æ‡¥Ç ‡¥™‡µÇ‡¥∞‡¥ø‡¥™‡µç‡¥™‡¥ø‡¥ö‡µç‡¥ö‡¥§‡¥ø‡¥®‡µÅ‡¥∂‡µá‡¥∑‡¥Ç ‡¥Æ‡¥æ‡¥§‡µç‡¥∞‡¥Ç
  showLoadingPopup("Submitting registration...");

  const originalBtnText = submitBtn.textContent;
  submitBtn.textContent = 'Submitting Pls Wait...';
  submitBtn.disabled = true;

  const fd = new FormData(form);
  const fileInput = form.querySelector('input[name="photoFile"]');
  const file = fileInput.files[0];

  let base64 = "";
  if(file){
    try {
        const reader = await new Promise((res,rej)=>{
            const r = new FileReader();
            r.onload = e => res(e.target.result);
            r.onerror = rej;
            r.readAsDataURL(file);
        });
        base64 = reader.split(',')[1];
    } catch (e) {
        // ‡¥™‡¥∞‡¥æ‡¥ú‡¥Ø‡¥Ç: ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ Submit ‡¥é‡¥®‡µç‡¥®‡µç ‡¥§‡¥®‡µç‡¥®‡µÜ ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡µÅ‡¥®‡µç‡¥®‡µÅ
        statusDiv.style.color = 'red';
        statusDiv.textContent = 'Error reading file.';
        submitBtn.textContent = originalBtnText; // Submit
        submitBtn.disabled = false;
        return;
    }
  }

  const params = new URLSearchParams();
  for(const [k,v] of fd.entries()){
    if(k === 'photoFile') continue;
    params.append(k, v);
  }
  params.append('photo', base64);
  params.append('photoName', file ? file.name : "");
  params.append('photoType', file ? file.type : "");

  try{
    const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
    const text = await res.text();

    if(text.includes('ALREADY_REGISTERED')){
      // 2. ‡¥™‡¥∞‡¥æ‡¥ú‡¥Ø‡¥Ç: ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ Submit ‡¥é‡¥®‡µç‡¥®‡µç ‡¥§‡¥®‡µç‡¥®‡µÜ ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡µÅ‡¥®‡µç‡¥®‡µÅ
      submitBtn.textContent = originalBtnText; // Submit
      submitBtn.disabled = false; 
      
      // 3. ‡¥Æ‡µÜ‡¥∏‡µç‡¥∏‡µá‡¥ú‡µç: ‡¥Æ‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ
      statusDiv.style.color = 'orange';
      statusDiv.textContent = 'This phone number is already registered. Please login.';
      
    } else if(text.includes('Success')){

      // SUCCESS POPUP SHOW HERE
      hideLoadingPopup(); 
      showSuccessPopup();
      
      // 2. ‡¥µ‡¥ø‡¥ú‡¥Ø‡¥Ç: ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ Submitted ‡¥é‡¥®‡µç‡¥®‡µç ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
      submitBtn.textContent = 'Submitted';
      
      // 3. ‡¥Æ‡µÜ‡¥∏‡µç‡¥∏‡µá‡¥ú‡µç: ‡¥Æ‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ
      statusDiv.style.color = 'green';
      statusDiv.style.fontWeight = 'bold';
      statusDiv.textContent = 'Registration successful! Please login.';
      
      // ‡¥´‡µã‡¥Ç ‡¥±‡µÄ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
      form.reset(); 
      // ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥™‡¥¥‡¥Ø‡¥™‡µã‡¥≤‡µÜ‡¥Ø‡¥æ‡¥ï‡¥æ‡µª ‡¥ï‡µÅ‡¥±‡¥ö‡µç‡¥ö‡µç ‡¥∏‡¥Æ‡¥Ø‡¥Ç ‡¥®‡µΩ‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
      setTimeout(() => {
        submitBtn.textContent = originalBtnText; // Submit
        submitBtn.disabled = false;
        statusDiv.style.fontWeight = 'normal';
      }, 3000); 
      
    } else {
      // 2. ‡¥™‡¥∞‡¥æ‡¥ú‡¥Ø‡¥Ç: ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ Submit ‡¥é‡¥®‡µç‡¥®‡µç ‡¥§‡¥®‡µç‡¥®‡µÜ ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡µÅ‡¥®‡µç‡¥®‡µÅ
      submitBtn.textContent = originalBtnText; // Submit
      submitBtn.disabled = false; 
      
      // 3. ‡¥Æ‡µÜ‡¥∏‡µç‡¥∏‡µá‡¥ú‡µç: ‡¥Æ‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ
      statusDiv.style.color = 'red';
      statusDiv.textContent = 'Error: ' + text;
    }
    // ‡¥Æ‡µÜ‡¥∏‡µç‡¥∏‡µá‡¥ú‡µç ‡¥ï‡¥æ‡¥£‡¥ø‡¥ö‡µç‡¥ö ‡¥∂‡µá‡¥∑‡¥Ç ‡¥Æ‡µÅ‡¥ï‡¥≥‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥∏‡µç‡¥ï‡µç‡¥∞‡µã‡µæ ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
  } catch(err){
    // 2. ‡¥™‡¥∞‡¥æ‡¥ú‡¥Ø‡¥Ç: ‡¥¨‡¥ü‡µç‡¥ü‡µ∫ Submit ‡¥é‡¥®‡µç‡¥®‡µç ‡¥§‡¥®‡µç‡¥®‡µÜ ‡¥®‡¥ø‡¥≤‡¥®‡¥ø‡µº‡¥§‡µç‡¥§‡µÅ‡¥®‡µç‡¥®‡µÅ
    submitBtn.textContent = originalBtnText; // Submit
    submitBtn.disabled = false;
    
    // 3. ‡¥Æ‡µÜ‡¥∏‡µç‡¥∏‡µá‡¥ú‡µç: ‡¥Æ‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ
    statusDiv.style.color = 'red';
    statusDiv.textContent = 'Network error.';
    console.error(err);
  }
hideLoadingPopup();  // ‚úÖ popup close
}

  /* ========== SEARCH (UPDATED) ========== */
/* ========== SEARCH (UPDATED) ========== */
async function applySearch() {

  showLoadingPopup("Searching‚Ä¶ Please wait");   // ‚≠ê FIRST LINE

  await loadSentInterests();   // ‚≠ê Refresh latest status
  
  if (!loggedProfile) {
    alert("Please login first to search.");
    showPage('pageLogin');
    hideLoadingPopup();        // ‚≠ê very important
    return;
  }


  
  // 1. ‡¥≤‡µã‡¥ó‡¥ø‡µª ‡¥ö‡µÜ‡¥Ø‡µç‡¥§ ‡¥Ø‡µÇ‡¥∏‡¥±‡µÅ‡¥ü‡µÜ ‡¥µ‡¥ø‡¥µ‡¥∞‡¥ô‡µç‡¥ô‡µæ ‡¥é‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
  const loggedReligion = (loggedProfile.Religion || "").toLowerCase();
  const loggedGender = (loggedProfile.Gender || "").toLowerCase();
  const oppositeGender = (loggedGender === "male") ? "female" : "male";

  // 2. ‡¥é‡¥≤‡µç‡¥≤‡¥æ ‡¥™‡µç‡¥∞‡µä‡¥´‡µà‡¥≤‡µÅ‡¥ï‡¥≥‡¥ø‡µΩ ‡¥®‡¥ø‡¥®‡µç‡¥®‡µÅ‡¥Ç Opposite Gender-‡¥â‡¥Ç Same Religion-‡¥â‡¥Ç ‡¥´‡¥ø‡µΩ‡¥ü‡µç‡¥ü‡µº ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
  const basePool = allProfiles.filter(p => {
    return ((p.Gender || "").toLowerCase() === oppositeGender) &&
           ((p.Religion || "").toLowerCase() === loggedReligion);
  });
  
  // 3. ‡¥§‡¥ø‡¥∞‡¥Ø‡µΩ ‡¥´‡¥ø‡µΩ‡¥ü‡µç‡¥ü‡¥±‡µÅ‡¥ï‡µæ ‡¥é‡¥ü‡µÅ‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
  const ageMin = parseInt(document.getElementById('ageMin').value) || 18;
  const ageMax = parseInt(document.getElementById('ageMax').value) || 99;
  const district = (document.getElementById('district').value || "").toLowerCase();
  const disability = (document.getElementById('disability').value || "").toLowerCase();

  // 4. Base Pool-‡µΩ (Opposite Gender & Same Religion) ‡¥§‡¥ø‡¥∞‡¥Ø‡µΩ ‡¥´‡¥ø‡µΩ‡¥ü‡µç‡¥ü‡¥±‡µÅ‡¥ï‡µæ ‡¥™‡µç‡¥∞‡¥Ø‡µã‡¥ó‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
  const results = basePool.filter(p=>{
    const age = parseInt(p.Age) || calculateAge(p['Date of Birth']);
    const dist = (p.District||"").toLowerCase();
    const dis = (p['Disability Details']||"").toLowerCase();
    const ageOk = age >= ageMin && age <= ageMax;
    const distOk = !district || dist === district;
    const disOk = !disability || dis.includes(disability);
    return ageOk && distOk && disOk;
  });

  // set for pagination/display
  filteredProfiles = results;
  currentPage = 1;
  showPage('pageResults');
  displayProfiles();
   hideLoadingPopup();   // ‚≠ê HIDE POPUP
}

/* ========== DISPLAY / PAGINATION ========== */
function displayProfiles(){
  

  const list = filteredProfiles || [];
  const resultsDiv = document.getElementById("results");
  resultsDiv.innerHTML = "";

  if(list.length === 0){
    resultsDiv.innerHTML = "<p>No matching profiles found.</p>";
    document.getElementById("pagination").innerHTML = "";
    return;
  }

  const start = (currentPage - 1) * profilesPerPage;
  const end = start + profilesPerPage;
  const pageProfiles = list.slice(start, end);

  pageProfiles.forEach(p => {
    const card = document.createElement("div");
    card.className = "card";

    // ‚úÖ Photo
    const photoUrl = convertDriveLink(p["Photo Link"] || p["Upload Your Photo"] || "");
    const photoHtml = photoUrl
      ? `<img src="${photoUrl}" alt="photo" onclick="openModal('${photoUrl.replace(/'/g, "\\'")}')">`
      : `<div class="no-photo">No Photo</div>`;

    // ‚úÖ Interest button check
    const recipientPhone = p['Your Phone Number'] || '';
    let buttonHtml = '';
    const interestStatus = (typeof interestsSentByMe !== 'undefined' && interestsSentByMe.get)
      ? interestsSentByMe.get(recipientPhone)
      : null;

    if (interestStatus === 'SENT') {
    buttonHtml = `
        <button onclick="cancelInterest('${recipientPhone}', this)"
                class="action-btn"
                style="background:#ff8800;">
            Cancel Interest ‚ùå
        </button>
    `;
}
else if (interestStatus === 'ACCEPTED') {
    buttonHtml = `
        <button disabled class="action-btn" style="background:#007bff;">
            Interest Accepted ü§ù
        </button>`;
}
else if (interestStatus === 'REJECTED') {
    buttonHtml = `
        <button disabled class="action-btn" style="background:#dc3545;">
            Interest Rejected ‚ùå
        </button>`;
}
else {
    buttonHtml = `
        <button class="action-btn"
            onclick="sendInterest('${recipientPhone}', this)"
            style="background:#00b050;">
            Send Interest ‚ù§Ô∏è
        </button>
    `;
}





    // ‚úÖ Profile card structure
    card.innerHTML = `
      ${photoHtml}
      <div class="info">
        <b>Name:</b> ${p.Name || ''}<br>
        <b>Age:</b> ${calculateAge(p['Date of Birth']) || 'N/A'}<br>
        <b>Gender:</b> ${p.Gender || ''}<br>
        <b>Religion:</b> ${p.Religion || ''}<br>
        <b>Caste:</b> ${p.Caste || ''}<br>
        <b>Disability:</b> ${p['Disability Details'] || ''}<br>
        <b>Education:</b> ${p.Education || ''}<br>
        <b>Job:</b> ${p.Job || ''}<br>
        <b>Marital Status:</b> ${p['Marital Status'] || ''}<br>
        <b>Full Address:</b> ${p['Full Address'] || ''}<br>
        <b>District:</b> ${p.District || ''}<br>
        <b>Contact 1:</b> ${p['Contact Number 1'] || ''}<br>
        <b>Contact 2:</b> ${p['Contact Number 2'] || ''}<br>
        <b>About Me:</b> ${p['About Me'] || ''}<br>
      </div>
      <div style="text-align:center; margin-top:10px;">
        ${buttonHtml}
      </div>
    `;
    resultsDiv.appendChild(card);
  });

  // ‚úÖ Pagination
  const paginationDiv = document.getElementById("pagination");
  paginationDiv.innerHTML = `
    <button onclick="prevPage()">Previous</button>
    Page ${currentPage} of ${Math.ceil(list.length / profilesPerPage)}
    <button onclick="nextPage()">Next</button>
  `;
}

function nextPage(){
  if(currentPage < Math.ceil(filteredProfiles.length / profilesPerPage)){
    currentPage++;
    displayProfiles();
    window.scrollTo({ top: 0, behavior: "smooth" });  // ‚≠ê ADD THIS
  }
}
function prevPage(){
  if(currentPage > 1){
    currentPage--;
    displayProfiles();
    window.scrollTo({ top: 0, behavior: "smooth" });  // ‚≠ê ADD THIS
  }
}


 /* ========== MY PROFILE UI & ACTIONS (UPDATED) ========== */
function showMyProfile(profile){
  if(!profile) return;
  document.getElementById('myProfileSection').style.display = 'block';
  const photo = convertDriveLink(profile['Photo Link'] || profile['Upload Your Photo'] || "");
  document.getElementById('myProfilePhoto').src = photo || "https://via.placeholder.com/150?text=No+Photo";
  
  const details = document.getElementById('myProfileDetails');
  
  // ‚úÖ ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥∏‡µç‡¥±‡µç‡¥±‡µà‡¥≤‡¥ø‡¥Ç‡¥ó‡µç, ‡¥ï‡µÇ‡¥ü‡µÅ‡¥§‡µΩ ‡¥°‡µÄ‡¥±‡µç‡¥±‡µÜ‡¥Ø‡¥ø‡µΩ‡¥∏‡µç ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
  details.innerHTML = `
    <h3 style="margin:6px 0;">${escapeHtml(profile.Name||'')}</h3>
    
    <div style="text-align:left; margin: 10px auto; font-size: 15px;">
        <p><b>Date of Birth:</b> ${escapeHtml(profile["Date of Birth"]||'')}</p>
        <p><b>Age:</b> ${calculateAge(profile['Date of Birth']) || 'N/A'}</p>
        <p><b>Gender:</b> ${escapeHtml(profile.Gender||'')}</p>
        <p><b>Height:</b> ${escapeHtml(profile.Height||'')}</p>
        <p><b>Religion:</b> ${escapeHtml(profile.Religion||'')}</p>
        <p><b>Caste:</b> ${escapeHtml(profile.Caste||'')}</p>
        <p><b>Disability Details:</b> ${escapeHtml(profile["Disability Details"]||'')}</p>
        <p><b>Education:</b> ${escapeHtml(profile.Education||'')}</p>
        <p><b>Job:</b> ${escapeHtml(profile.Job||'')}</p>
        <p><b>Marital Status:</b> ${escapeHtml(profile["Marital Status"]||'')}</p>
        <p><b>District:</b> ${escapeHtml(profile.District||'')}</p>
        
        <div style="text-align:left; margin: 10px auto; font-size: 15px;">
            <b>Contact Number 1:</b> ${escapeHtml(profile["Contact Number 1"]||'')}</p>
        <p><b>Contact Number 2:</b> ${escapeHtml(profile["Contact Number 2"]||'')}</p>
        <p><b>Full Address:</b> ${escapeHtml(profile["Full Address"]||'')}</p>
        
        <p style="margin-top: 15px; border-top: 1px solid #eee; padding-top: 10px;">
            <b>About Me:</b> ${escapeHtml(profile["About Me"]||'')}</p>
    </div>
  `;
  
  // store locally for actions (only phone is needed for action identity)
  localStorage.setItem('loggedProfile', JSON.stringify({
      "Your Phone Number": profile["Your Phone Number"],
      "Date of Birth": profile["Date of Birth"],
  }));
  loggedProfile = profile;
  document.getElementById('myProfileStatus').textContent = "";
}


/* ‚úèÔ∏è EDIT PROFILE (NEW LOGIC) */
function editProfile() {
  if (!loggedProfile) { alert('Please login first'); return; }
  
  // 1. ‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥´‡µã‡¥Æ‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
  document.getElementById('editName').value = loggedProfile.Name || '';
  document.getElementById('editDob').value = loggedProfile['Date of Birth'] || ''; // DOB is not editable
  document.getElementById('editHeight').value = loggedProfile.Height || '';
  document.getElementById('editDisability').value = loggedProfile['Disability Details'] || '';
  document.getElementById('editEducation').value = loggedProfile.Education || '';
  document.getElementById('editJob').value = loggedProfile.Job || '';
  document.getElementById('editMaritalStatus').value = loggedProfile['Marital Status'] || '';
  document.getElementById('editAddress').value = loggedProfile['Full Address'] || '';
  document.getElementById('editDistrict').value = loggedProfile.District || '';
  document.getElementById('editContact1').value = loggedProfile['Contact Number 1'] || '';
  document.getElementById('editContact2').value = loggedProfile['Contact Number 2'] || '';
  document.getElementById('editAboutMe').value = loggedProfile['About Me'] || '';
  
  document.getElementById('editStatus').textContent = "";
  
  // 2. ‡¥é‡¥°‡¥ø‡¥±‡µç‡¥±‡µç ‡¥™‡µá‡¥ú‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥™‡µã‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
  showPage('pageEdit');
}
 
/* üíæ UPDATE PROFILE (NEW LOGIC) */
/* üíæ UPDATE PROFILE ‚Äî FINAL SUPER FAST VERSION */
async function updateProfile() {
  if (!loggedProfile) { 
      alert('Login required to update profile.');
      showPage('pageLogin');
      return;
  }

  showLoadingPopup("Updating your profile...");

  const status = document.getElementById('editStatus');
  const form = document.getElementById('editForm');

  if (!form.checkValidity()) {
      status.style.color = 'red';
      status.textContent = 'Please fill all required fields.';
      hideLoadingPopup();
      return;
  }

  // ‚≠ê‚≠ê Correct: Use ONLY FormData (Apps Script needs this)
  const fd = new FormData(form);
  fd.append("action", "editProfile");

  // add phone number for server lookup
  appendUserIdentity(fd);

  try {
      status.style.color = '#555';
      status.textContent = 'Updating profile... Please wait...';

      // ‚≠ê‚≠ê Correct POST request
      const res = await fetch(SCRIPT_URL, { 
          method: 'POST', 
          body: fd 
      });

      const text = await res.text();

      if (text.includes('PROFILE_UPDATED')) {

          status.style.color = 'green';
          status.textContent = 'Profile updated! Refreshing...';

          // üîÑ Refresh everything (correct & latest data)
          await reloadAllProfiles();
          refreshLoggedProfile();
          localStorage.setItem("loggedProfile", JSON.stringify(loggedProfile));
          showMyProfile(loggedProfile);

          showPage('pageSearch');  // back to search

      } 
      else if (text.includes('PROFILE_NOT_FOUND')) {
          status.style.color = 'red';
          status.textContent = 'Error: Profile not found. Please re-login.';
      } 
      else {
          status.style.color = 'red';
          status.textContent = 'Error updating profile: ' + text;
      }

  } catch (err) {
      status.style.color = 'red';
      status.textContent = 'Network error.';
      console.error(err);
  } finally {
      hideLoadingPopup();
  }
}



/* Change profile photo */
function changePhoto() {
  if (!loggedProfile) { 
    alert('Please login first'); 
    return; 
  }

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';

  input.onchange = async () => {
    const file = input.files[0];
    if (!file) return;
    if (!confirm('Replace your profile photo?')) return;

    const reader = new FileReader();

    reader.onload = async (e) => {
      const base64 = e.target.result.split(',')[1];

      const formData = new FormData();
      showLoadingPopup("Uploading your photo...");

      formData.append('action', 'updatePhoto');
      appendUserIdentity(formData);

      formData.append('photo', base64);
      formData.append('photoName', file.name);
      formData.append('photoType', file.type || 'image/jpeg');

      const status = document.getElementById('myProfileStatus');
      status.style.color = '#555';
      status.textContent = 'Uploading photo... Please wait.';

      try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const text = await res.text();

        if (text.includes('PHOTO_UPDATED')) {

          status.style.color = 'green';
          status.textContent = 'Photo updated. Refreshing...';

          // ‚≠ê‚≠ê‚≠ê MAIN FIX ‚Äî SUPER FAST LIVE UPDATE ‚≠ê‚≠ê‚≠ê
          await reloadAllProfiles();
refreshLoggedProfile();
localStorage.setItem("loggedProfile", JSON.stringify(loggedProfile));
showMyProfile(loggedProfile);


        } else {
          status.style.color = 'red';
          status.textContent = 'Failed: ' + text;
        }

      } catch (err) {
        status.style.color = 'red';
        status.textContent = 'Network error';
        console.error(err);
      }

      hideLoadingPopup();
    };

    reader.readAsDataURL(file);
  };

  input.click();
}


/* Delete profile photo */
/* üóëÔ∏è DELETE PROFILE PHOTO ‚Äî FINAL FAST VERSION */
async function deletePhoto() {
    if (!loggedProfile) { 
        alert('Please login first'); 
        return; 
    }

    if (!confirm('Remove your profile photo?')) return;

    showLoadingPopup("Deleting your photo...");

    const status = document.getElementById('myProfileStatus');
    status.style.color = '#555';
    status.textContent = 'Deleting photo... please wait...';

    const formData = new FormData();
    formData.append('action', 'deletePhoto');   // Apps Script action
    appendUserIdentity(formData);               // adds phone number

    try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const text = await res.text().then(t => t.trim());

        hideLoadingPopup();

        if (text.includes('PHOTO_DELETED')) {

            status.style.color = 'green';
            status.textContent = 'Photo removed successfully.';

            // ‚≠ê UI Instant Refresh
            document.getElementById('myProfilePhoto').src =
                "https://via.placeholder.com/150?text=No+Photo";

            await reloadAllProfiles();
refreshLoggedProfile();
localStorage.setItem("loggedProfile", JSON.stringify(loggedProfile));
showMyProfile(loggedProfile);



        } else {
            status.style.color = 'red';
            status.textContent = 'Failed: ' + text;
        }

    } catch (e) {
        hideLoadingPopup();
        status.style.color = 'red';
        status.textContent = 'Network error. Please try again.';
        console.error(e);
    }
}


/* Delete entire profile */
/* ‚ùå DELETE ENTIRE PROFILE ‚Äî FINAL SAFE VERSION */
async function deleteProfile() {
    if (!loggedProfile) { 
        alert('Please login first'); 
        return; 
    }

    if (!confirm('‚ö†Ô∏è Delete your entire profile permanently? This cannot be undone.')) {
        return;
    }

    showLoadingPopup("Deleting your profile...");

    const status = document.getElementById('myProfileStatus');
    status.style.color = '#555';
    status.textContent = 'Deleting profile... please wait...';

    const formData = new FormData();
    formData.append('action', 'deleteProfile');  
    appendUserIdentity(formData);               // adds phone safely

    try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: formData });
        const text = await res.text().then(t => t.trim());

        hideLoadingPopup();

        if (text.includes('PROFILE_DELETED')) {

            status.style.color = 'green';
            status.textContent = 'Your profile has been deleted permanently.';

            // ‚≠ê Instant Safe Logout
            setTimeout(() => {
                logout(); // clears localStorage, back to login page
            }, 1000);

        } else {
            status.style.color = 'red';
            status.textContent = 'Failed: ' + text;
        }

    } catch (e) {
        hideLoadingPopup();
        status.style.color = 'red';
        status.textContent = 'Network error. Please try again.';
        console.error(e);
    }
}


  /* ========== UTILS ========== */
  function calculateAge(dobString){
    if(!dobString) return null;
    // normalize digits in string
    const s = (dobString||'').replace(/[^\d]/g,' ').trim().split(/\s+/);
    if(s.length < 3) return null;
    const [d,m,y] = s.map(x=>parseInt(x)||0);
    if(!d || !m || !y) return null;
    const birth = new Date(y, m-1, d);
    const today = new Date();
    let age = today.getFullYear() - birth.getFullYear();
    const md = today.getMonth() - birth.getMonth();
    if(md < 0 || (md===0 && today.getDate() < birth.getDate())) age--;
    return age;
  }
  function escapeHtml(str){ 
  if(!str) return ''; 
  return String(str).replace(/[&<>"']/g, s => ({
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  }[s]));
}
  
  /* ‚úÖ Helper: Only include phone for security-sensitive actions */
  function appendUserIdentity(params) {
    let phone = "";

    try {
      const saved = localStorage.getItem("loggedProfile");
      if (saved) {
        loggedProfile = JSON.parse(saved);
        phone = (loggedProfile && loggedProfile["Your Phone Number"])
          ? String(loggedProfile["Your Phone Number"]).trim()
          : "";
      } else {
        console.warn("‚ö†Ô∏è No profile found in localStorage!");
      }
    } catch (err) {
      console.error("Error loading profile from localStorage:", err);
    }

    if (!phone) {
      alert("‚ö†Ô∏è Phone number missing. Please logout and login again.");
      return params;
    }

    // ‚úÖ Only append 'phone' (Used for server-side lookup/update)
    if (params instanceof FormData) {
      params.append("phone", phone);
    } else if (params instanceof URLSearchParams) {
      params.append("phone", phone);
    } else {
      console.warn("appendUserIdentity(): Unknown params type");
    }

    return params;
  }



  /* helper to go back to search from results */
  function backToSearch(){ showPage('pageSearch'); }

  /* Initialize ‚Äî fill DOB selects and show login */
  fillDobSelects(); // ‚úÖ ‡¥á‡¥µ‡¥ø‡¥ü‡µÜ‡¥Ø‡¥æ‡¥£‡µç ‡¥à ‡¥ï‡µã‡¥°‡µç ‡¥ö‡µá‡µº‡¥ï‡µç‡¥ï‡µá‡¥£‡µç‡¥ü‡¥§‡µç
  showPage('pageLogin');
  
 /* ========== INTEREST LIST DISPLAY CONTROLS (FIXED) ========== */

function showInterestList(type) {
    if (!loggedProfile) { 
        alert("Please login first."); 
        showPage('pageLogin');
        return; 
    }

    // ‚úÖ ‡¥á‡¥§‡¥æ‡¥£‡µç ‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥Ø ‡¥∏‡µç‡¥•‡¥æ‡¥®‡¥Ç
    currentInterestListType = type; // 'received' or 'accepted'

    // ‚úÖ ‡¥™‡µÅ‡¥§‡¥ø‡¥Ø ‡¥™‡µá‡¥ú‡¥ø‡¥≤‡µá‡¥ï‡µç‡¥ï‡µç ‡¥™‡µã‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    showPage('pageInterests'); 
    
    // ‡¥π‡µÜ‡¥°‡¥ø‡¥Ç‡¥ó‡µç ‡¥∏‡µÜ‡¥±‡µç‡¥±‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡µÅ‡¥®‡µç‡¥®‡µÅ
    const title = (type === 'received') ? 'üì• Received Interests' : 'ü§ù Accepted Interests';
    document.getElementById('interestListTitle').textContent = title;
    
    // ‡¥°‡¥æ‡¥±‡µç‡¥± ‡¥≤‡µã‡¥°‡µç ‡¥ö‡µÜ‡¥Ø‡µç‡¥Ø‡¥æ‡µª ‡¥µ‡¥ø‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
    loadAndDisplayInterests(type); 
}

/* ========== LOAD AND DISPLAY INTERESTS (DATA FETCHER) ========== */
async function loadAndDisplayInterests(type) {
    const phone = loggedProfile['Your Phone Number'];
    const resultsDiv = document.getElementById("interestResults"); 
    
    resultsDiv.innerHTML = "<p style='text-align:center; color: #007bff;'>Loading profiles, please wait...</p>";
    document.getElementById("interestPagination").innerHTML = "";

    const params = new URLSearchParams();
    params.append('action', 'getInterestsList'); 
    params.append('userPhone', phone);
    params.append('listType', type); 

    try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const text = await res.text();
        
        let interestProfiles;
        try {
            interestProfiles = JSON.parse(text); 
        } catch (e) {
            interestsList = [];
            resultsDiv.innerHTML = `<p style='color:red; text-align:center;'>Error loading data: ${text || "Invalid response."}</p>`;
            displayInterestProfiles(); // Error ‡¥µ‡¥®‡µç‡¥®‡¥æ‡µΩ empty list ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥Ç
            return;
        }
        
        interestsList = interestProfiles || []; 
        currentInterestPage = 1;
        displayInterestProfiles(type); 
        
    } catch (e) {
        interestsList = [];
        console.error(e);
        resultsDiv.innerHTML = `<p style='color:red; text-align:center;'>Network Error fetching data.</p>`;
        displayInterestProfiles();
    }
}
/* ========== ACCEPT INTEREST ========== */
async function acceptInterest(senderPhone) {
    if (!loggedProfile) return;

    if (!confirm('Accept this interest? Their contact details will be shared.')) return;

    const recipientPhone = loggedProfile['Your Phone Number'];

    // üü¢ SHOW POPUP
    showLoadingPopup("ACCEPTING‚Ä¶ Please wait");

    const params = new URLSearchParams();
    params.append('action', 'acceptInterest');
    params.append('senderPhone', senderPhone);
    params.append('recipientPhone', recipientPhone);

    try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const text = await res.text().then(t => t.trim());

        hideLoadingPopup(); // üü¢ HIDE POPUP IMMEDIATELY

        if (text.includes('INTEREST_ACCEPTED')) {
            alert('Interest accepted!');

            // Reload list
            showInterestList('received');
        } else {
            alert('Error accepting interest: ' + text);
        }
    } catch (e) {
        hideLoadingPopup(); // üü¢ HIDE ON ERROR
        alert('Network error.');
    }
}

async function rejectInterest(senderPhone) {
    if (!loggedProfile) return;

    if (!confirm('Reject this interest?')) return;

    const recipientPhone = loggedProfile['Your Phone Number'];

    // üü¢ SHOW POPUP
    showLoadingPopup("REJECTING‚Ä¶ Please wait");

    const params = new URLSearchParams();
    params.append('action', 'rejectInterest');
    params.append('senderPhone', senderPhone);
    params.append('recipientPhone', recipientPhone);

    try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const text = await res.text().then(t => t.trim());

        hideLoadingPopup(); // üü¢ HIDE POPUP

        if (text.includes('INTEREST_REJECTED')) {
            alert('Interest rejected ‚ùå');
            showInterestList('received');
        } else {
            alert('Error rejecting interest: ' + text);
        }
    } catch (e) {
        hideLoadingPopup(); // üü¢ HIDE POPUP
        alert('Network error rejecting interest');
    }
}


/* ========== DISPLAY INTEREST PROFILES (PAGINATED VIEW) ========== */
function displayInterestProfiles(listType = 'received'){
    const list = interestsList || [];
    const resultsDiv = document.getElementById("interestResults");
    resultsDiv.innerHTML = "";

    if(list.length === 0){
      resultsDiv.innerHTML = `<p style='text-align:center; color:#0056b3;'>No ${listType === 'received' ? 'new' : 'accepted'} interests found.</p>`;
      document.getElementById("interestPagination").innerHTML = "";
      return;
    }

    const start = (currentInterestPage - 1) * interestProfilesPerPage;
    const end = start + interestProfilesPerPage;
    const pageProfiles = list.slice(start, end);

    pageProfiles.forEach(p => {
        const card = document.createElement("div");
        card.className = "card";
        
        const photoUrl = convertDriveLink(p["Photo Link"] || p["Upload Your Photo"] || "");
        const photoHtml = photoUrl
            ? `<img src="${photoUrl}" alt="photo" onclick="openModal('${photoUrl.replace(/'/g, "\\'")}')">`
            : `<div class="no-photo">No Photo</div>`;

        const senderPhone = p['Your Phone Number'] || 'N/A';

        // ‚úÖ Accept + Reject buttons (Received list ONLY)
        let actionButtons = "";
        if(listType === 'received'){
            actionButtons = `
                <button onclick="acceptInterest('${senderPhone}')" 
                        class="small-btn" 
                        style="background:#28a745; width:100%; margin-bottom:6px;">
                    Accept Interest ‚úÖ
                </button>

                <button onclick="rejectInterest('${senderPhone}')" 
                        class="small-btn" 
                        style="background:#dc3545; width:100%;">
                    Reject Interest ‚ùå
                </button>
            `;
        }

        card.innerHTML = `
            ${photoHtml}
            <div class="info">
                <b>Name:</b> ${p.Name||''}<br>
                <b>Age:</b> ${calculateAge(p['Date of Birth']) || 'N/A'}<br>
                <b>Gender:</b> ${p.Gender||''}<br>
                <b>Religion:</b> ${p.Religion||''}<br>
                <b>Caste:</b> ${p.Caste||''}<br>
                <b>Disability:</b> ${p['Disability Details']||''}<br>
                <b>Education:</b> ${p.Education||''}<br>
                <b>Job:</b> ${p.Job||''}<br>
                <b>Marital Status:</b> ${p['Marital Status']||''}<br>
                <b>Full Address:</b> ${p['Full Address']||''}<br>
                <b>District:</b> ${p.District||''}<br>
                <b>Contact 1:</b> ${p['Contact Number 1']||''}<br>
                <b>Contact 2:</b> ${p['Contact Number 2']||''}<br>
                <b>About Me:</b> ${p['About Me']||''}<br>
            </div>
            <div style="text-align:center; margin-top:10px;">
                ${actionButtons}
            </div>
        `;

        resultsDiv.appendChild(card);
    });

    // ‡¥™‡µá‡¥ú‡¥ø‡¥®‡µá‡¥∑‡µª ‡¥¨‡¥ü‡µç‡¥ü‡¥£‡µÅ‡¥ï‡µæ
    const paginationDiv = document.getElementById("interestPagination");
    const totalPages = Math.ceil(list.length / interestProfilesPerPage);
    paginationDiv.innerHTML = `
        <button onclick="prevInterestPage()" ${currentInterestPage === 1 ? 'disabled' : ''}>Previous</button> 
        Page ${currentInterestPage} of ${totalPages} 
        <button onclick="nextInterestPage()" ${currentInterestPage === totalPages ? 'disabled' : ''}>Next</button>`;
} 
/* ========== SEND INTEREST FUNCTION (FINAL WORKING) ========== */
async function sendInterest(recipientPhone, btn) {
    if (!loggedProfile) {
        alert("Please login to send interest.");
        showPage('pageLogin');
        return;
    }

    const senderPhone = loggedProfile['Your Phone Number'];

    // ----------------------------------------------------
    // üëâ 1. Update ONLY this button immediately
    // ----------------------------------------------------
    interestsSentByMe.set(recipientPhone, "SENT");

    btn.textContent = "Cancel Interest";
    btn.textContent = "Cancel Interest ‚ùå";
btn.style.background = "#ff8800";

    // ----------------------------------------------------
    // üëâ 2. Background API call (NO UI RELOAD)
    // ----------------------------------------------------
    const params = new URLSearchParams();
    params.append("action", "sendInterest");
    params.append("senderPhone", senderPhone);
    params.append("recipientPhone", recipientPhone);

    try {
        const res = await fetch(SCRIPT_URL, { method: "POST", body: params });
        const text = (await res.text()).trim();

        if (text.includes("INTEREST_SENT")) {
            console.log("Interest sent backend OK");
            return;
        }

        if (text.includes("ALREADY_SENT")) {
            // backend says already sent ‚Üí keep button as Cancel
            interestsSentByMe.set(recipientPhone, "SENT");
            return;
        }

        // ----------------------------------------------------
        // üëâ 3. Error ‚Üí revert only button
        // ----------------------------------------------------
        alert("Server Error: " + text);
        interestsSentByMe.delete(recipientPhone);

        btn.textContent = "Send Interest";
        btn.classList.remove("cancel-btn");
        btn.classList.add("send-btn");

    } catch (err) {
        // Network error ‚Üí revert the same button
        alert("Network error. Please try again.");
        interestsSentByMe.delete(recipientPhone);

        btn.textContent = "Send Interest";
        btn.classList.remove("cancel-btn");
        btn.classList.add("send-btn");
    }
}




/* ========== INTEREST PAGINATION LOGIC ========== */
function nextInterestPage(){
    if(currentInterestPage < Math.ceil(interestsList.length / interestProfilesPerPage)){
      currentInterestPage++;
      // ‡¥®‡¥ø‡¥≤‡¥µ‡¥ø‡µΩ ‡¥ï‡¥æ‡¥£‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥® ‡¥≤‡¥ø‡¥∏‡µç‡¥±‡µç‡¥±‡µç ‡¥è‡¥§‡µÜ‡¥®‡µç‡¥®‡µç ‡¥ï‡¥£‡µç‡¥ü‡µÜ‡¥§‡µç‡¥§‡¥ø ‡¥µ‡µÄ‡¥£‡µç‡¥ü‡µÅ‡¥Ç ‡¥µ‡¥ø‡¥≥‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ
      const currentType = document.getElementById('interestListTitle').textContent.includes('Received') ? 'received' : 'accepted';
      displayInterestProfiles(currentType);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}

function prevInterestPage(){
    if(currentInterestPage > 1){
      currentInterestPage--;
      const currentType = document.getElementById('interestListTitle').textContent.includes('Received') ? 'received' : 'accepted';
      displayInterestProfiles(currentType);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
}


/* ========== LOAD SENT INTERESTS AFTER LOGIN ========== */
async function loadSentInterests() {
    if (!loggedProfile) return;

    const senderPhone = loggedProfile['Your Phone Number'];
    const params = new URLSearchParams();
    params.append('action', 'getSentInterests');
    params.append('senderPhone', senderPhone);

    try {
        const res = await fetch(SCRIPT_URL, { method: 'POST', body: params });
        const text = await res.text();
        let records = [];

        try {
            records = JSON.parse(text);
        } catch (e) {
            console.warn("Invalid JSON from getSentInterests:", text);
            interestsSentByMe.clear();
            return;
        }

        interestsSentByMe.clear();
        records.forEach(rec => {
            // Normalize status to uppercase tokens (SENT/ACCEPTED/REJECTED)
            const st = (rec.status || "").toString().trim().toUpperCase();
            interestsSentByMe.set((rec.recipientPhone || "").toString().trim(), st);
        });

        console.log("‚úÖ Sent interests loaded:", Array.from(interestsSentByMe.entries()));
    } catch (e) {
        console.error("Error loading sent interests", e);
    }
}

async function cancelInterest(recipientPhone, btn) {
    if (!loggedProfile) {
        alert("Please login first.");
        showPage('pageLogin');
        return;
    }

    const senderPhone = loggedProfile['Your Phone Number'];

    // ----------------------------------------------------
    // üëâ 1. Update ONLY this button immediately
    // ----------------------------------------------------
    interestsSentByMe.delete(recipientPhone);

    btn.textContent = "Send Interest ‚ù§Ô∏è";
    btn.textContent = "Send Interest ‚ù§Ô∏è";
btn.style.background = "#00b050";


    // ----------------------------------------------------
    // üëâ 2. Check latest status from server (NO UI RELOAD)
    // ----------------------------------------------------
    const checkParams = new URLSearchParams();
    checkParams.append("action", "getSentInterests");
    checkParams.append("senderPhone", senderPhone);

    try {
        const checkRes = await fetch(SCRIPT_URL, { method: "POST", body: checkParams });
        const checkText = await checkRes.text();

        let sentArr = [];
        try {
            sentArr = JSON.parse(checkText);
        } catch (e) {
            console.log("JSON parse failed", checkText);
        }

        const entry = sentArr.find(x => x.recipientPhone === recipientPhone);

        // If already cancelled in backend:
        if (!entry || entry.status !== "SENT") {
            console.log("Already cancelled on server");
            return;
        }

        // ----------------------------------------------------
        // üëâ 3. Send cancel request to server
        // ----------------------------------------------------
        const params = new URLSearchParams();
        params.append("action", "cancelInterest");
        params.append("senderPhone", senderPhone);
        params.append("recipientPhone", recipientPhone);

        const res = await fetch(SCRIPT_URL, { method: "POST", body: params });
        const text = (await res.text()).trim();

        if (text.includes("INTEREST_CANCELLED")) {
            console.log("Cancel OK on backend");
            return;
        }

        // ----------------------------------------------------
        // üëâ 4. Error ‚Üí restore previous UI (only button)
        // ----------------------------------------------------
        alert("Error: " + text);

        interestsSentByMe.set(recipientPhone, "SENT");
        btn.textContent = "Cancel Interest ‚ùå";
        btn.classList.remove("send-btn");
        btn.classList.add("cancel-btn");

    } catch (err) {
        alert("Network error while cancelling.");

        interestsSentByMe.set(recipientPhone, "SENT");
        btn.textContent = "Cancel Interest ‚ùå";
        btn.classList.remove("send-btn");
        btn.classList.add("cancel-btn");
    }
}


function findProfile(phone){
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName("Database");
    const data = sheet.getDataRange().getValues();
    const headers = data[0];

    const phoneIdx = headers.indexOf("Your Phone Number");

    for (let i = 1; i < data.length; i++) {
        if (String(data[i][phoneIdx]).trim() === String(phone).trim()) {
            const row = data[i];
            const obj = {};
            headers.forEach((h, j) => obj[h] = row[j]);
            return obj;
        }
    }
    return null;
}

function refreshLoggedProfile() {
    const phone = loggedProfile["Your Phone Number"];
    if (!phone) return;

    const updated = allProfiles.find(p => 
        (p["Your Phone Number"] || "").trim() === phone.trim()
    );

    if (updated) {
        loggedProfile = updated;
        console.log("üîÑ Logged profile refreshed:", loggedProfile);
    } else {
        console.warn("‚ö† Unable to refresh loggedProfile after reload");
    }
}
async function reloadAllProfiles() {
  return new Promise(async (resolve, reject) => {
    try {
      const res = await fetch(SHEET_CSV_URL, {
         cache: "no-store"
      });

      const csv = await res.text();

      Papa.parse(csv, {
        header: true,
        skipEmptyLines: true,
        complete: function(results) {
          allProfiles = results.data || [];
          resolve(true);
        }
      });

    } catch (e) {
      reject(e);
    }
  });
}
async function loadProfiles() {
    const res = await fetch(SHEET_CSV_URL, { cache: "no-store" });
    const csv = await res.text();

    return new Promise((resolve, reject) => {
        Papa.parse(csv, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                resolve(results.data);
            },
            error: reject
        });
    });
}
async function preloadCSV() {
    try {
        const res = await fetch(SHEET_CSV_URL + "&v=" + Date.now());
        const csv = await res.text();

        allProfiles = await new Promise((resolve, reject) => {
            Papa.parse(csv, {
                header: true,
                skipEmptyLines: true,
                complete: r => resolve(r.data),
                error: reject
            });
        });

        csvReady = true;  // üî• CSV loaded completely
        console.log("CSV Loaded Successfully");

    } catch (err) {
        console.error("CSV Load Failed", err);
    }
}
async function loadProfilesFully() {
    return new Promise(async (resolve, reject) => {
        try {
            const res = await fetch(SHEET_CSV_URL + "&v=" + Date.now(), { cache: "no-store" });
            const csv = await res.text();

            Papa.parse(csv, {
                header: true,
                skipEmptyLines: true,
                complete: function (results) {
                    allProfiles = results.data || [];
                    resolve(true);
                },
                error: reject
            });

        } catch (e) {
            reject(e);
        }
    });
}



  </script>
  </body>
  </html>



